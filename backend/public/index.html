<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Smart Traffic Density Control</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            heavy: "#ef4444",
            moderate: "#f59e0b",
            light: "#10b981",
          }
        }
      }
    }
  </script>

  <style>
    body {
      background: #0b1120;
      color: #e5e7eb;
      font-family: 'Inter', sans-serif;
    }

    /* Glow for GREEN lane */
    .lane-green {
      box-shadow: 0 0 25px rgba(16, 185, 129, 0.8), 
                  0 0 40px rgba(16, 185, 129, 0.3);
      border-color: #10b981 !important;
    }

    .bar {
      transition: height 0.4s ease;
      border-radius: 6px;
      width: 45px;
      margin: 0 auto;
    }
  </style>
</head>

<body class="p-6">

  <h1 class="text-4xl font-bold tracking-tight text-white mb-6">
    Smart Traffic Density Control
  </h1>

  <!-- Grid Container -->
  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">

    <!-- Lane Cards -->
    <div id="lanes" class="lg:col-span-8 grid grid-cols-1 sm:grid-cols-2 gap-6"></div>

    <!-- Bar Chart -->
    <div class="lg:col-span-4 bg-slate-800 rounded-xl p-6 border border-slate-700">
      <h2 class="text-xl font-bold text-white mb-4">Distance Comparison</h2>

      <div class="flex justify-around items-end h-64" id="chart"></div>

      <div class="flex justify-around text-slate-400 text-sm mt-4">
        <span>LANE 1</span>
        <span>LANE 2</span>
        <span>LANE 3</span>
        <span>LANE 4</span>
      </div>
    </div>

  </div>

  <footer class="mt-8 text-sm text-slate-400">
    Last Updated: <span id="last">--</span>
  </footer>

<script>
const LANES = ["lane1", "lane2", "lane3", "lane4"];
const REFRESH_MS = 1000;

// Category logic for distance
function getCategory(dist) {
  if (dist < 30) return { text: "HEAVY", color: "heavy" };
  if (dist < 60) return { text: "MODERATE", color: "moderate" };
  return { text: "LIGHT", color: "light" };
}

// Build lane cards
function buildLaneCards() {
  const container = document.getElementById("lanes");
  container.innerHTML = "";

  LANES.forEach((lane, i) => {
    const card = document.createElement("div");
    card.id = "card-" + i;
    card.className =
      "bg-slate-800 rounded-xl border border-slate-700 p-6 shadow-lg transition-all";

    card.innerHTML = `
      <div class="flex justify-between">
        <h2 class="text-xl font-bold text-white">Lane ${i + 1}</h2>
        <span id="signal-${i}" 
              class="px-2 py-0.5 text-xs font-semibold bg-slate-700 rounded-full text-white">
          RED
        </span>
      </div>

      <div class="text-xs text-slate-400 mt-2">Ultrasonic | COAP</div>

      <div id="value-${i}" class="text-5xl font-extrabold mt-4">--</div>
      <p class="text-slate-400">cm</p>

      <span id="cat-${i}" 
            class="inline-block mt-4 px-3 py-1 rounded-full text-xs font-bold">
        --
      </span>
    `;

    container.appendChild(card);
  });
}

// Update a lane card
function updateLane(i, distance, isGreen) {
  document.getElementById(`value-${i}`).textContent = distance;

  const card = document.getElementById(`card-${i}`);
  const signal = document.getElementById(`signal-${i}`);
  const catEl = document.getElementById(`cat-${i}`);

  const { text, color } = getCategory(distance);

  catEl.textContent = text;
  catEl.className = `mt-4 px-3 py-1 rounded-full text-xs font-bold bg-${color}`;

  if (isGreen) {
    signal.textContent = "GREEN";
    signal.className = "px-3 py-1 rounded-full text-xs font-bold bg-green-500 text-black";
    card.classList.add("lane-green");
  } else {
    signal.textContent = "RED";
    signal.className = "px-3 py-1 rounded-full text-xs font-bold bg-red-500 text-black";
    card.classList.remove("lane-green");
  }
}

// Update bar chart
function updateChart(data, greenLane) {
  const chart = document.getElementById("chart");
  chart.innerHTML = "";

  LANES.forEach((lane, i) => {
    const dist = data[lane];
    const { color } = getCategory(dist);
    const height = Math.max(20, 250 - dist * 2);

    const bar = document.createElement("div");
    bar.className = `bar bg-${color}`;
    bar.style.height = height + "px";

    if (i === greenLane) {
      bar.style.outline = "4px solid #10b981";
    }

    chart.appendChild(bar);
  });
}

// Fetch CoAP data
async function getData() {
  try {
    const res = await fetch("/latest");
    if (!res.ok) throw new Error();
    return await res.json();
  } catch {
    // fallback demo values
    return {
      lane1: 35,
      lane2: 80,
      lane3: 20,
      lane4: 95
    };
  }
}

// Update loop
async function loop() {
  const data = await getData();

  // FIND THE LANE WITH MINIMUM DISTANCE
  let greenLane = 0;
  let minVal = data[LANES[0]];

  for (let i = 1; i < LANES.length; i++) {
    if (data[LANES[i]] < minVal) {
      minVal = data[LANES[i]];
      greenLane = i;
    }
  }

  // Update lanes
  LANES.forEach((lane, i) => {
    updateLane(i, data[lane], i === greenLane);
  });

  // Update chart
  updateChart(data, greenLane);

  // Update timestamp
  document.getElementById("last").textContent =
    new Date().toLocaleTimeString();

  setTimeout(loop, REFRESH_MS);
}

// Init
buildLaneCards();
loop();
</script>

</body>
</html>
